# ⚠️ @claude: please update the git commit and date + time in the line below on changes ⚠️
# Pure-Rust Redox | Build: virtio-gpu-pci | 2026-01-17 15:45

# Various daemons that relibc needs to function as well as a bunch of env vars
# that should be set for every program.
export PATH /scheme/initfs/bin
export RUST_BACKTRACE 1
# Suppress INFO/DEBUG logging - set to 'info' or 'debug' for verbose boot
export RUST_LOG warn
# Parallelize independent daemons for faster boot
nowait rtcd
nowait nulld
nowait zerod
nowait randd

# Logging
logd
stdio /scheme/log
nowait ramfs logging

# Graphics infrastructure
export RUST_LOG warn
nowait inputd

# Start vesad for ramfb (boot framebuffer) mode - exits quickly if no framebuffer
vesad
unset FRAMEBUFFER_ADDR FRAMEBUFFER_VIRT FRAMEBUFFER_WIDTH FRAMEBUFFER_HEIGHT FRAMEBUFFER_STRIDE

# Live disk - needs priority before drivers search for disks
nowait lived

# Drivers (includes PCI driver spawner which starts virtio-gpu if present)
# Must run BEFORE fbbootlogd/fbcond so virtio-gpu display scheme exists
run /scheme/initfs/etc/init_drivers.rc

# Now start graphics console daemons (display scheme should exist by now)
export RUST_LOG warn
nowait fbbootlogd
nowait fbcond 1 2
unset RSDP_ADDR RSDP_SIZE

# Mount rootfs
redoxfs --uuid $REDOXFS_UUID file $REDOXFS_BLOCK
unset REDOXFS_UUID REDOXFS_BLOCK REDOXFS_PASSWORD_ADDR REDOXFS_PASSWORD_SIZE

# Exit initfs
cd /
export PATH /usr/bin
run.d /usr/lib/init.d /etc/init.d
